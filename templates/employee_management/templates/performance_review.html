{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Performance Reviews</h4>
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addReviewModal">Submit Review</button>
    </div>
    <div class="card-body">
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Employee</th>
            <th>Review Period</th>
            <th>Reviewer</th>
            <th>Score</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for review in reviews %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ review.employee_name }}</td>
            <td>{{ review.review_period }}</td>
            <td>{{ review.reviewer_name }}</td>
            <td>{{ review.score }}/10</td>
            <td><span class="badge bg-success">{{ review.status }}</span></td>
          </tr>
          {% empty %}
          <tr>
            <td>1</td>
            <td>Amit Sharma</td>
            <td>Q1 2025</td>
            <td>Ravi Kumar</td>
            <td>8/10</td>
            <td><span class="badge bg-success">Completed</span></td>
          </tr>
          <tr>
            <td>2</td>
            <td>Neha Singh</td>
            <td>Q1 2025</td>
            <td>Priya Mehra</td>
            <td>—</td>
            <td><span class="badge bg-warning text-dark">Pending</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal for New Review -->
<div class="modal fade" id="addReviewModal" tabindex="-1" aria-labelledby="addReviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="addReviewModalLabel">Submit Performance Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addReviewFormModal" method="post">
          {% csrf_token %}
          <div class="form-group mb-3">
            <label for="employee_name">Employee Name</label>
            <input type="text" class="form-control" id="employee_name" name="employee_name" required>
          </div>
          <div class="form-group mb-3">
            <label for="review_period">Review Period</label>
            <input type="text" class="form-control" id="review_period" name="review_period" placeholder="e.g., Q2 2025" required>
          </div>
          <div class="form-group mb-3">
            <label for="reviewer_name">Reviewer</label>
            <input type="text" class="form-control" id="reviewer_name" name="reviewer_name" required>
          </div>
          <div class="form-group mb-3">
            <label for="score">Score (1–10)</label>
            <input type="number" class="form-control" id="score" name="score" min="1" max="10" required>
          </div>
          <div class="form-group mb-3">
            <label for="status">Status</label>
            <select class="form-select" id="status" name="status" required>
              <option value="Pending">Pending</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="submit" form="addReviewFormModal" class="btn btn-success">Submit</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('addReviewFormModal').addEventListener('submit', function (e) {
  e.preventDefault();
  const form = this;
  const formData = new FormData(form);
  fetch('#', {
    method: 'POST',
    headers: { 'X-Requested-With': 'XMLHttpRequest' },
    body: formData
  })
    .then(response => response.ok ? response.text() : Promise.reject())
    .then(() => {
      const modal = bootstrap.Modal.getInstance(document.getElementById('addReviewModal'));
      modal.hide();
      location.reload();
    })
    .catch(() => form.submit());
});
</script>
{% endblock %}
